# DRY

- 英語：Don't Repeat Yourself
- 日本語：繰り返しを避けよ

## 【どういうこと】コードのコピペ厳禁

同じコードを書いてはいけません。コードの重複で最も多いのはひとまとまりのロジックを、安易に別の場所にコピペして使用した場合です。これにより同じロジックが複数箇所にばらまかれてしまいます。

```java
private void funcA() {
  Proc1;
  Proc2;
  Proc3;
}
private void funcB() {
  Proc4;
  Proc2; // コピペしてしまった
  Proc5;
}
```

また同じ条件を扱う制御文のブロック軍が様々な場所に重複して現れてしまう場合もあります。これもやはりコピペの産物です。条件の分岐が同じで分岐後の処理が異なる場合、一旦コピペしてから処理の部分のみ書き換えているのです。

```java
private void funcA() {
  if (a) {
    XXX
  } else if (b) {
    YYY
  } else if (c) {
    ZZZ
  }
}
private void funcB() {
  if (a) { // 同じ条件が重複している
    AAA
  } else if (b) { // 同じ条件が重複している
    BBB
  } else if (c) { // 同じ条件が重複している
    CCC
  }
}
```

「定数リテラル」を直接コードに埋め込んであることもコードの重複に当たります。同じ意味の定数が複数箇所で使われている場合、定数の指し示す情報が重複して存在することになるからです。

```java
private void funcA() {
  if ( value == 16) {
    ...
  }

  ...

  if ( value == 16) {
    ...
  }
}
```

また単純なコードの重複ではありませんが、ただ単にコードをそのまま説明しているコメントも重複に当たります。コードを母国語に約しているだけのコメントもこのケースです。
これらの重複を避けるようにコードを書きましょう。また見つけた場合は速やかに重複を排除するようにしましょう。

## 【どうして】コードを改善できなくなる

コードに重複があると障害修正や機能追加などコードを改善していくことが困難になります。具体的には以下の困難が発生します。

### コードを読む作業が難しくなる  

同じコードが複数あると量的に「より多く」なり、質的に「より複雑」になります。その為単純にコードを読む作業が難しくなります。コードが正確に把握できないと修正の方針すら立てることができません。

### コードを修正する作業が難しくなる  

同じようなコードが複数あると、その複数箇所を正確に修正しなければ整合が取れません。慎重に作業しないと修正漏れの危険性があります。

また、完全に同じコードでももしかしたら今回の回収に必要ない箇所もあるかもしれません。そうなるとそれぞれの箇所で周りのコードを読んで修正の要不要を判断しなければなりません。

さらに現在の重複コードに微差がある場合も各々の場所で更にコードを深く読み込まなければなりません。制御文の条件の中身や制御文の条件数に少し差があると難易度はかなり高くなります。最悪解読不能で修正不能になります。

### テストがない

重複しているコードは大抵の場合レガシーなコードです。その部分にテストはありません。一念発起して修正してもテストがない状態では新たな障害を生んでしまうリスクがかなり高くなります。

## 【どうすれば】コードを抽象化する

コードを「抽象化」することによって、重複を排除しましょう。
コードのロジックを抽象化するには**処理のまとまりに名前をつけて「関数化」「モジュール化」します。**またデータであればそれに名前をつけて定数を定義します。そしてそれらを繰り返し出てくる部分と置き換えます。  
抽象化することで以下のメリットが生まれます。

- コードの呂が減り読む量を減らすことができる。
- ロジックやデータに「名前」が付くので、コードが読みやすくなる。
- 同じコードが1箇所に集約され修正箇所が1箇所で済むので品質を担保しやすくなる
- 抽象化した部分は再利用しやすくなる。新しい機能を追加する際、コードの再利用によって、より早く、より品質よくプログラミングを完了できる。

抽象化を行うにはメンタル面で乗り越えなければならない壁があります。例えばロジックを関数にするのであればそれなりの時間がかかります。またもとの動いたコードを変えてしまうのでデグレードのリスクがあります。しかし重複が良くないということに議論の余地はありません。時間を取ってでも面倒であっても重複を排除するようにしましょう。

## 【発展】DRYの適用範囲

DRYの適用範囲はコードだけにとどまりません。設計書についても重複は避けるべきです。こちらも修正があったときの反映漏れのリスクがあるからです。

また、ソフトウエアの開発作業には「同じことの繰り返し」が多くあります。この作業についてもDRYを適用すべきです。具体的には繰り返し作業を「自動化」します。これにより手作業の負担がなくなり作業が正確になります。人によるばらつきもなくなります。

## 【関連】

### WET(Write Everything Twice)の原則  

DRYの対義語です。DRY担っていないコードへの皮肉的な表現として使用されます。

### OFOP(One Fact, One Place)の原則  

「事実は一つの場所に一つだけ存在するべき」という考え方です。データベース設計理論におけるテーブル設計の要となる原則です。DRYと同じようにOFOPではデータベースに格納されるデータの重複を禁じています。
