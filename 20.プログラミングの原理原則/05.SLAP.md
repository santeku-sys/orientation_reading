# SLAP

- 英語：Single Level of Abstraction Principle
- 日本語：抽象化レベルの統一

## 【どういうこと】コードのレベルを合わせる

コードを書くとき、高いレベルの抽象化概念（高水準）と、低いレベルの抽象化概念を分離するようにします。その際、高低2階層ではなく、機能の複雑さに応じて多階層に分離します。そしてそれら各々の層に所属する抽象レベルを揃えます。つまり、関数を抽象レベルに沿って分割していき、同じ関数に属するコードの抽象化レベルをすべて統一するということです。  

抽象レベルが揃うと結果的にコードは優れた書籍のようになります。優れた書籍は綿密に構成されています。各セクションへの分割やレイアウトに入念な配慮がされています。巻頭から巻末まで順序どおりに通読すると最も自然に読めますが、参考資料として任意の位置の内容を閲覧することも可能です。

コードの抽象化レベルを揃えると、この優れた書籍のように読むことができるのです。最高水準から中間水準の処理が「書籍の目次」となり、最低水準の処理が「書籍の本文内容」のようになります。

```java
//レベル1の目次
private void 高水準(){ 
  //同じ抽象度の関数を書く
  中水準1();
  中水準2();
}

//レベル2の目次
private void 中水準1(){ 
  //同じ抽象度の関数を書く
  低水準1();
  低水準2();
}

//レベル2の目次
private void 中水準2(){ 
  //同じ抽象度の関数を書く
  低水準3();
}

private void 低水準1(){ 
  // 具体的な処理
}

private void 低水準2(){ 
  // 具体的な処理
}

private void 低水準3(){ 
  // 具体的な処理
}
```

## 【どうして】コードに「要約性」と「閲覧性」をもたらす

コードがレベルが揃った関数に分割されていると、「要約性」と「閲覧性」を同時に満たすことになります。つまり関数の一覧は目次のようになり要約性を持つようになります。そして分割された関数は小さなコードの塊になり閲覧性が良くなります。同じところには同じ抽象度の処理、というようにコードが統一されているとコードはよどみなく流れ、理解しやすくなります。

逆にコードを読んでいて急に抽象度が変わるとコードの流れが途切れます。これまで読んできた部分の理解が飛び、読む人の邪魔をしてしまいます。

## 【どうすれば】関数を構造化する

関数を構造化しましょう。処理を意図の伝わりやすい抽象化レベルが揃った小さなステップ軍の関数に変換しましょう。

関数を構造化すると各関数は自身より1段階低いレベルの関数を呼び出す処理が中心となります。このような他の関数を呼び出すコードで構成された関数を「複合関数（Composed Method）」と呼びます。複合関数は極力小さくします。 **名前で意図を伝えるのであれば処理が1行であったとしても関数にして構いません。** 

また、複合関数の中では、様々な抽象レベルの関数を呼ばないようにします。1つの関数の中で、ある部分ではデータベースの接続という低水準の処理を行い、他の部分ではビジネスロジックの実行という高水準の処理を行う、という不揃いの書き方をしてはいけんません。

## 【発展】SLAPの適用範囲

SLAPは関数に限らず「モジュール」や「クラス」にも適用されます。優れたソフトウエア設計においては概念が複数のレベルに分離され、それらは異なる入れ物に格納されます。例えばオブジェクト指向におけるクラス設計の場合だと、この入れ物は「抽象クラス」とその「継承クラス」になります。  

抽象クラスに高いレベルの概念をもたせ、その継承クラスに低いレベルの概念をもたせることでSLAPを実現できます。ただしこのとき低いレベルの概念は継承クラスのみに含まれ高いレベルの概念は抽象クラスのみに含まれるようにする必要があります。

## 【発展】SLAPの手順

SLAP化の作業は文章を書くときの手順が参考になります。 **優れた文章を書く肝は「内容を書くこと」と「内容をわかりやすく伝えるための構成を考えること」を別の作業にすることです。** この作業の分断が、コードを書く場合にも当てはまります。  

つまり具体的な処理を書く作業と抽象化レベルを揃える作業はモードを切り替え別の作業として行うようにしましょう。そのほうが作業がやりやすく結果的により良いコードになります。

## 【関連】コードと書籍のアナロジー

優れた書籍は良いコードを書くうえで参考になります。そこで書籍の構成要素についてそれぞれコードではそれが何にあたり、優れたコードにするには土のう用にすれば良いかを考案します。

### 序文  

書籍の序文はその本の主旨が示され大きな視点でその本の位置づけが説明されます。これはコードではファイルの先頭のコメントに当たります。このコメントにはコードの記述内容を説明し、そのコードがどのプロジェクトに属するものであるかを明記します。

### 目次  

書籍の目次はコードでは関数の一覧になります。それ故「コードの先頭にはそのコードのすべての関数のリストを記述すべき」という考えもあります。しかし統合開発環境やエディタの関数一覧機能、ジャンプ機能を考慮すると、これは冗長で不要でしょう。  

ただし関数一覧機能、ジャンプ機能がない設計書などのドキュメントに、目次があれば非常に読みやすく非常に効果的です。

### セクション  

書籍はいくつのもセクションに別れている場合があります。コードも1つのファイルに複数のモジュールが記述されている場合やファイル内の関数を論理的にいくつかのグループに分類できる場合などは複数の大きなセクションに分割できます。  

各セクションの区切りを示す防波堤コメントが論理的な区切りを明示するのに役立ちます。C#だと# regionディレクティブを使用するのも良いでしょう。  

ただし単一ファイルにあまりにも多くの内容を記述するのは懸命ではありません。内容が紛らわしくなり理解しにくくファイル内の移動も面倒です。よってコードの場合、量が多ければセクションを分けるよりファイルを分けてしまう方が得策です。

### 章  

書籍の章は自己完結した人まとまりの内容に適切なタイトルをつけたものです。これはコードでは関数に相当します。SLAPを適用した構造化された関数を作成します。

### 段落  

書籍の段落は関数内のコードのブロックに相当します。書籍の段落のように論理的なまとまりを空白区切りで表現します。各関数のロジックは文の羅列になっていますが、論理的なブロックに分け空白行によって皇族のコードと分離します。この空白行は構造上の意味は持ちませんがコードを読みやすくレイアウトするために追加します。

### 文  

書籍の各文はコード1つ1つのステートメントに相当します。書籍の文章がそうであるように、読みやすくするためには1つの文章はできるだけ短く、かつ1つのことだけ書くようにします。
